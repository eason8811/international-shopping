<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="shopping.international.infrastructure.dao.products.ProductMapper">

    <sql id="OnSaleBaseWhere">
        FROM product p
        WHERE p.status = 'ON_SALE'
        AND EXISTS (SELECT 1 FROM product_sku s WHERE s.product_id = p.id AND s.status = 'ENABLED')
        <if test="categoryId != null">
            AND p.category_id = #{categoryId}
        </if>
        <if test="keyword != null and keyword != ''">
            AND (
            p.title LIKE CONCAT('%', #{keyword}, '%')
            OR p.subtitle LIKE CONCAT('%', #{keyword}, '%')
            <if test="locale != null and locale != ''">
                OR EXISTS (
                SELECT 1 FROM product_i18n pi
                WHERE pi.product_id = p.id
                AND pi.locale = #{locale}
                AND (pi.title LIKE CONCAT('%', #{keyword}, '%') OR pi.subtitle LIKE CONCAT('%', #{keyword}, '%'))
                )
            </if>
            )
        </if>
        <if test="tags != null and tags.size() > 0">
            AND (
            <foreach collection="tags" item="tag" separator=" OR ">
                JSON_CONTAINS(p.tags, CONCAT('\"', #{tag}, '\"'))
                <if test="locale != null and locale != ''">
                    OR EXISTS (
                    SELECT 1 FROM product_i18n pi
                    WHERE pi.product_id = p.id
                    AND pi.locale = #{locale}
                    AND JSON_CONTAINS(pi.tags, CONCAT('\"', #{tag}, '\"'))
                    )
                </if>
            </foreach>
            )
        </if>
        <if test="currency != null and currency != ''">
            AND EXISTS (
            SELECT 1
            FROM product_sku s
            JOIN product_price pp ON pp.sku_id = s.id
            WHERE s.product_id = p.id
            AND s.status = 'ENABLED'
            AND pp.currency = #{currency}
            AND pp.is_active = 1
            <if test="priceMin != null">AND COALESCE(pp.sale_price, pp.list_price) >= #{priceMin}</if>
            <if test="priceMax != null"><![CDATA[AND COALESCE(pp.sale_price, pp.list_price) <= #{priceMax}]]></if>
            )
        </if>
    </sql>

    <select id="selectOnSalePage" resultType="shopping.international.infrastructure.dao.products.po.ProductPO">
        SELECT p.*
        <include refid="OnSaleBaseWhere"/>
        <choose>
            <when test="sortBy == 'SALES_DESC'">
                ORDER BY p.sale_count DESC, p.updated_at DESC
            </when>
            <when test="sortBy == 'PRICE_ASC' and currency != null and currency != ''">
                ORDER BY (
                SELECT MIN(COALESCE(pp.sale_price, pp.list_price))
                FROM product_sku s
                JOIN product_price pp ON pp.sku_id = s.id
                WHERE s.product_id = p.id AND s.status = 'ENABLED' AND pp.currency = #{currency} AND pp.is_active = 1
                ) ASC, p.updated_at DESC
            </when>
            <when test="sortBy == 'PRICE_DESC' and currency != null and currency != ''">
                ORDER BY (
                SELECT MAX(COALESCE(pp.sale_price, pp.list_price))
                FROM product_sku s
                JOIN product_price pp ON pp.sku_id = s.id
                WHERE s.product_id = p.id AND s.status = 'ENABLED' AND pp.currency = #{currency} AND pp.is_active = 1
                ) DESC, p.updated_at DESC
            </when>
            <otherwise>
                ORDER BY p.updated_at DESC
            </otherwise>
        </choose>
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="countOnSale" resultType="long">
        SELECT COUNT(1)
        <include refid="OnSaleBaseWhere"/>
    </select>

    <select id="selectOnSaleBySlug" resultType="shopping.international.infrastructure.dao.products.po.ProductPO">
        SELECT p.*
        FROM product p
        WHERE p.slug = #{slug}
          AND p.status = 'ON_SALE'
          AND EXISTS (SELECT 1 FROM product_sku s WHERE s.product_id = p.id AND s.status = 'ENABLED')
        LIMIT 1
    </select>

    <select id="selectOnSaleByLocalizedSlug" resultType="shopping.international.infrastructure.dao.products.po.ProductPO">
        SELECT p.*
        FROM product p
                 JOIN product_i18n pi ON pi.product_id = p.id
        WHERE p.status = 'ON_SALE'
          AND pi.locale = #{locale}
          AND pi.slug = #{slug}
          AND EXISTS (SELECT 1 FROM product_sku s WHERE s.product_id = p.id AND s.status = 'ENABLED')
        LIMIT 1
    </select>

</mapper>
