<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="shopping.international.infrastructure.dao.products.ProductMapper">

    <!-- 商品图片 -->
    <resultMap id="ProductImageResultMap" type="shopping.international.infrastructure.dao.products.po.ProductImagePO">
        <id column="id" property="id"/>
        <result column="product_id" property="productId"/>
        <result column="url" property="url"/>
        <result column="is_main" property="isMain"/>
        <result column="sort_order" property="sortOrder"/>
        <result column="created_at" property="createdAt"/>
    </resultMap>

    <!-- 规格值多语言 -->
    <resultMap id="ProductSpecValueI18nResultMap" type="shopping.international.infrastructure.dao.products.po.ProductSpecValueI18nPO">
        <id column="value_id" property="valueId"/>
        <id column="locale" property="locale"/>
        <result column="value_name" property="valueName"/>
        <result column="created_at" property="createdAt"/>
    </resultMap>

    <!-- 规格值 -->
    <resultMap id="ProductSpecValueResultMap" type="shopping.international.infrastructure.dao.products.po.ProductSpecValuePO">
        <id column="id" property="id"/>
        <result column="product_id" property="productId"/>
        <result column="spec_id" property="specId"/>
        <result column="value_code" property="valueCode"/>
        <result column="value_name" property="valueName"/>
        <result column="attributes" property="attributes"/>
        <result column="sort_order" property="sortOrder"/>
        <result column="status" property="status"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
        <collection property="i18nList" resultMap="ProductSpecValueI18nResultMap" columnPrefix="value_i18n_"/>
    </resultMap>

    <!-- 规格多语言 -->
    <resultMap id="ProductSpecI18nResultMap" type="shopping.international.infrastructure.dao.products.po.ProductSpecI18nPO">
        <id column="spec_id" property="specId"/>
        <id column="locale" property="locale"/>
        <result column="spec_name" property="specName"/>
        <result column="created_at" property="createdAt"/>
    </resultMap>

    <!-- 规格 -->
    <resultMap id="ProductSpecResultMap" type="shopping.international.infrastructure.dao.products.po.ProductSpecPO">
        <id column="id" property="id"/>
        <result column="product_id" property="productId"/>
        <result column="spec_code" property="specCode"/>
        <result column="spec_name" property="specName"/>
        <result column="spec_type" property="specType"/>
        <result column="is_required" property="isRequired"/>
        <result column="sort_order" property="sortOrder"/>
        <result column="status" property="status"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
        <collection property="i18nList" resultMap="ProductSpecI18nResultMap" columnPrefix="spec_i18n_"/>
        <collection property="values" resultMap="ProductSpecValueResultMap" columnPrefix="value_"/>
    </resultMap>

    <!-- 商品多语言 -->
    <resultMap id="ProductI18nResultMap" type="shopping.international.infrastructure.dao.products.po.ProductI18nPO">
        <id column="id" property="id"/>
        <id column="locale" property="locale"/>
        <result column="product_id" property="productId"/>
        <result column="title" property="title"/>
        <result column="subtitle" property="subtitle"/>
        <result column="description" property="description"/>
        <result column="slug" property="slug"/>
        <result column="tags" property="tags"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
    </resultMap>

    <!-- 商品聚合 -->
    <resultMap id="ProductAggregateResultMap" type="shopping.international.infrastructure.dao.products.po.ProductPO">
        <id column="product_id" property="id"/>
        <result column="product_title" property="title"/>
        <result column="product_subtitle" property="subtitle"/>
        <result column="product_description" property="description"/>
        <result column="product_slug" property="slug"/>
        <result column="product_category_id" property="categoryId"/>
        <result column="product_brand" property="brand"/>
        <result column="product_cover_image_url" property="coverImageUrl"/>
        <result column="product_stock_total" property="stockTotal"/>
        <result column="product_sale_count" property="saleCount"/>
        <result column="product_sku_type" property="skuType"/>
        <result column="product_status" property="status"/>
        <result column="product_default_sku_id" property="defaultSkuId"/>
        <result column="product_tags" property="tags"/>
        <result column="product_created_at" property="createdAt"/>
        <result column="product_updated_at" property="updatedAt"/>
        <collection property="gallery" resultMap="ProductImageResultMap" columnPrefix="image_"/>
        <collection property="specs" resultMap="ProductSpecResultMap" columnPrefix="spec_"/>
        <collection property="i18nList" resultMap="ProductI18nResultMap" columnPrefix="product_i18n_"/>
    </resultMap>

    <!-- 按ID聚合查询商品 -->
    <select id="selectAggregateById" resultMap="ProductAggregateResultMap">
        SELECT product.id                 AS product_id,
               product.title              AS product_title,
               product.subtitle           AS product_subtitle,
               product.description        AS product_description,
               product.slug               AS product_slug,
               product.category_id        AS product_category_id,
               product.brand              AS product_brand,
               product.cover_image_url    AS product_cover_image_url,
               product.stock_total        AS product_stock_total,
               product.sale_count         AS product_sale_count,
               product.sku_type           AS product_sku_type,
               product.status             AS product_status,
               product.default_sku_id     AS product_default_sku_id,
               product.tags               AS product_tags,
               product.created_at         AS product_created_at,
               product.updated_at         AS product_updated_at,
               product_image.id           AS image_id,
               product_image.product_id   AS image_product_id,
               product_image.url          AS image_url,
               product_image.is_main      AS image_is_main,
               product_image.sort_order   AS image_sort_order,
               product_image.created_at   AS image_created_at,
               product_spec.id            AS spec_id,
               product_spec.product_id    AS spec_product_id,
               product_spec.spec_code     AS spec_spec_code,
               product_spec.spec_name     AS spec_spec_name,
               product_spec.spec_type     AS spec_spec_type,
               product_spec.is_required   AS spec_is_required,
               product_spec.sort_order    AS spec_sort_order,
               product_spec.status        AS spec_status,
               product_spec.created_at    AS spec_created_at,
               product_spec.updated_at    AS spec_updated_at,
               spec_i18n.spec_id          AS spec_i18n_spec_id,
               spec_i18n.locale           AS spec_i18n_locale,
               spec_i18n.spec_name        AS spec_i18n_spec_name,
               spec_i18n.created_at       AS spec_i18n_created_at,
               spec_value.id              AS value_id,
               spec_value.product_id      AS value_product_id,
               spec_value.spec_id         AS value_spec_id,
               spec_value.value_code      AS value_value_code,
               spec_value.value_name      AS value_value_name,
               spec_value.attributes      AS value_attributes,
               spec_value.sort_order      AS value_sort_order,
               spec_value.status          AS value_status,
               spec_value.created_at      AS value_created_at,
               spec_value.updated_at      AS value_updated_at,
               spec_value_i18n.value_id   AS value_i18n_value_id,
               spec_value_i18n.locale     AS value_i18n_locale,
               spec_value_i18n.value_name AS value_i18n_value_name,
               spec_value_i18n.created_at AS value_i18n_created_at,
               product_i18n.id            AS product_i18n_id,
               product_i18n.product_id    AS product_i18n_product_id,
               product_i18n.locale        AS product_i18n_locale,
               product_i18n.title         AS product_i18n_title,
               product_i18n.subtitle      AS product_i18n_subtitle,
               product_i18n.description   AS product_i18n_description,
               product_i18n.slug          AS product_i18n_slug,
               product_i18n.tags          AS product_i18n_tags,
               product_i18n.created_at    AS product_i18n_created_at,
               product_i18n.updated_at    AS product_i18n_updated_at
        FROM product
                 LEFT JOIN product_image ON product_image.product_id = product.id
                 LEFT JOIN product_spec ON product_spec.product_id = product.id
                 LEFT JOIN product_spec_i18n spec_i18n ON spec_i18n.spec_id = product_spec.id
                 LEFT JOIN product_spec_value spec_value ON spec_value.spec_id = product_spec.id
                 LEFT JOIN product_spec_value_i18n spec_value_i18n ON spec_value_i18n.value_id = spec_value.id
                 LEFT JOIN product_i18n ON product_i18n.product_id = product.id
        WHERE product.id = #{productId}
        ORDER BY product.id,
                 product_image.is_main DESC, product_image.sort_order, product_image.id,
                 product_spec.sort_order, product_spec.id,
                 spec_value.sort_order, spec_value.id
    </select>

    <!-- 按 slug 聚合查询上架商品（支持本地化 slug 匹配） -->
    <select id="selectOnSaleAggregateBySlug" resultMap="ProductAggregateResultMap">
        WITH matched_product AS (SELECT p.id
                                 FROM product p
                                          LEFT JOIN product_i18n pi
                                                    ON pi.product_id = p.id
                                                        AND pi.locale = #{locale}
                                 WHERE p.status = 'ON_SALE'
                                   AND (p.slug = #{slug} OR (pi.slug = #{slug} AND pi.locale = #{locale}))
                                 LIMIT 1)
        SELECT product.id                 AS product_id,
               product.title              AS product_title,
               product.subtitle           AS product_subtitle,
               product.description        AS product_description,
               product.slug               AS product_slug,
               product.category_id        AS product_category_id,
               product.brand              AS product_brand,
               product.cover_image_url    AS product_cover_image_url,
               product.stock_total        AS product_stock_total,
               product.sale_count         AS product_sale_count,
               product.sku_type           AS product_sku_type,
               product.status             AS product_status,
               product.default_sku_id     AS product_default_sku_id,
               product.tags               AS product_tags,
               product.created_at         AS product_created_at,
               product.updated_at         AS product_updated_at,
               product_image.id           AS image_id,
               product_image.product_id   AS image_product_id,
               product_image.url          AS image_url,
               product_image.is_main      AS image_is_main,
               product_image.sort_order   AS image_sort_order,
               product_image.created_at   AS image_created_at,
               product_spec.id            AS spec_id,
               product_spec.product_id    AS spec_product_id,
               product_spec.spec_code     AS spec_spec_code,
               product_spec.spec_name     AS spec_spec_name,
               product_spec.spec_type     AS spec_spec_type,
               product_spec.is_required   AS spec_is_required,
               product_spec.sort_order    AS spec_sort_order,
               product_spec.status        AS spec_status,
               product_spec.created_at    AS spec_created_at,
               product_spec.updated_at    AS spec_updated_at,
               spec_i18n.spec_id          AS spec_i18n_spec_id,
               spec_i18n.locale           AS spec_i18n_locale,
               spec_i18n.spec_name        AS spec_i18n_spec_name,
               spec_i18n.created_at       AS spec_i18n_created_at,
               spec_value.id              AS value_id,
               spec_value.product_id      AS value_product_id,
               spec_value.spec_id         AS value_spec_id,
               spec_value.value_code      AS value_value_code,
               spec_value.value_name      AS value_value_name,
               spec_value.attributes      AS value_attributes,
               spec_value.sort_order      AS value_sort_order,
               spec_value.status          AS value_status,
               spec_value.created_at      AS value_created_at,
               spec_value.updated_at      AS value_updated_at,
               spec_value_i18n.value_id   AS value_i18n_value_id,
               spec_value_i18n.locale     AS value_i18n_locale,
               spec_value_i18n.value_name AS value_i18n_value_name,
               spec_value_i18n.created_at AS value_i18n_created_at,
               product_i18n.id            AS product_i18n_id,
               product_i18n.product_id    AS product_i18n_product_id,
               product_i18n.locale        AS product_i18n_locale,
               product_i18n.title         AS product_i18n_title,
               product_i18n.subtitle      AS product_i18n_subtitle,
               product_i18n.description   AS product_i18n_description,
               product_i18n.slug          AS product_i18n_slug,
               product_i18n.tags          AS product_i18n_tags,
               product_i18n.created_at    AS product_i18n_created_at,
               product_i18n.updated_at    AS product_i18n_updated_at
        FROM matched_product
                 JOIN product ON product.id = matched_product.id
                 LEFT JOIN product_image ON product_image.product_id = product.id
                 LEFT JOIN product_spec ON product_spec.product_id = product.id
                 LEFT JOIN product_spec_i18n spec_i18n ON spec_i18n.spec_id = product_spec.id
                 LEFT JOIN product_spec_value spec_value ON spec_value.spec_id = product_spec.id
                 LEFT JOIN product_spec_value_i18n spec_value_i18n ON spec_value_i18n.value_id = spec_value.id
                 LEFT JOIN product_i18n ON product_i18n.product_id = product.id
        ORDER BY product.id,
                 product_image.is_main DESC, product_image.sort_order, product_image.id,
                 product_spec.sort_order, product_spec.id,
                 spec_value.sort_order, spec_value.id
    </select>

</mapper>
