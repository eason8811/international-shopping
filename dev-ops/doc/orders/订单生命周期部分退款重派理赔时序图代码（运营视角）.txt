---
config:
  theme: redux-color
---
sequenceDiagram
    actor User as 用户(User)
    participant Client as 前端(Client)
    participant CS as 客服/运营(控制台)
    participant Backend as 后端(Backend)
    participant Pay as 支付网关(Payment)
    participant API as 承运商API(API)
    User->>Client: 发起售后（退款/异常/改址/理赔）
    Client->>CS: 创建工单(cs_ticket)(订单/包裹/原因/证据)
    activate CS
    rect rgb(245,245,255)
      note over Client,API: 预发货退款（全部未揽收）
      CS->>Backend: 批准发货前退款(order_no, ticket_id)
      activate Backend
      Backend->>Backend: 校验可退 & 锁单
      opt 已创建面单
        Backend->>API: 取消运单(ext_external_id / tracking_no)
        activate API
        API-->>Backend: 取消成功
        deactivate API
        Backend->>Backend: 更新 shipment.status=CANCELLED<br/>并写 shipment_status_log(to=CANCELLED, source=MANUAL/API)
      end
      Backend->>Backend: 写入退款单 payment_refund(status=INIT, reason_code=CUSTOMER_REQUEST,<br/> order_id, payment_order_id, amount=全额, ticket_id)
      opt 需要按行审计/对账
        Backend->>Backend: 写入退款项 payment_refund_item[*](order_item_id, quantity, amount)
      end
      Backend->>Pay: 退款请求(refund_no, amount, currency)
      activate Pay
      Pay-->>Backend: 退款受理(external_refund_id)
      deactivate Pay
      Backend->>Backend: 更新退款单 payment_refund SET external_refund_id=?, status=PENDING
      alt 回调/轮询SUCCESS
        Pay-->>Backend: 退款成功并回调, 带external_refund_id
        Backend->>Backend: 更新退款单 payment_refund.status=SUCCESS<br/>更新订单状态 orders.status=REFUNDED<br/>写 order_status_log(to=REFUNDED, source=ADMIN)
        Backend-->>CS: 回填退款结果(成功/金额/凭证)
      else FAIL/CLOSED
        Pay-->>Backend: 退款失败 FAIL/CLOSED
        Backend->>Backend: 更新退款单状态 payment_refund.status=FAIL/CLOSED
        Backend-->>CS: 通知人工处理
      end
      deactivate Backend
      CS-->>Client: 通知用户结果
    end
    deactivate CS
    rect rgb(245,255,245)
      note over Client,API: 已发货后异常（EXCEPTION / RETURNED / LOST 等）
      CS->>Backend: 审核方案(部分退款 / 重派 / 组合)，附 ticket_id
      activate CS
      activate Backend
      note over CS,Backend: 依据行项目与折扣分摊计算可退金额<br/>（可参考 order_discount_applied）
      par 方案1：部分退款
        Backend->>Backend: 新增退款单 payment_refund(status=INIT, reason_code=RETURNED/LOST/DAMAGED,<br/>amount=∑行, ticket_id)
        Backend->>Backend: 由于是部分退款，新增退款单明细<br/>payment_refund_item[*](order_item_id, quantity, amount)
        Backend->>Pay: 退款请求(refund_no, amount)
        activate Pay
        Pay-->>Backend: 退款受理(external_refund_id)
        deactivate Pay
        Backend->>Backend: 更新支付单状态 payment_refund SET external_refund_id=?, status=PENDING
        alt 回调/轮询SUCCESS
          Pay-->>Backend: 退款成功回调, 带 external_id
          Backend->>Backend: 更新退款单状态 payment_refund.status=SUCCESS
          note over Backend: 部分退款不改 orders.status（保持 PAID/FULFILLED）<br/>通过汇总退款单展示“已退金额”
          Backend-->>CS: 回填部分退款完成(金额/行明细)
        else FAIL/CLOSED
          Pay-->>Backend: 退款失败 FAIL/CLOSED
          Backend->>Backend: UPDATE payment_refund.status=FAIL/CLOSED
          Backend-->>CS: 通知重试/人工
        end
      and 方案2：重派（改址/补寄）
        CS->>Backend: 创建重派单(order_no, items_subset, ticket_id)
        Backend->>Backend: 新增运单 shipment(status=CREATED)<br/>新增运单明细 shipment_item[*]
        Backend->>API: CreateLabel/PlaceOrder
        activate API
        API-->>Backend: 返回 new tracking_no / ext_external_id
        deactivate API
        Backend->>Backend: 更新运单状态 shipment.status=LABEL_CREATED<br/>并写入运单状态变更记录 shipment_status_log(to=LABEL_CREATED, source=API)
        Backend-->>CS: 回填重派单号
      end
      deactivate Backend
      CS-->>Client: 通知用户（退款进度/新单号）
      deactivate CS
    end
    rect rgb(255,250,240)
      note over Client, API: 商品丢失 / 破损寻求承运商理赔
      CS->>Backend: OpenClaim(shipment_id, 证据, ticket_id)
      activate CS
      Backend->>API: CreateClaim(tracking_no, 证据)
      activate Backend
      activate API
      API-->>Backend: Claim Acknowledged(claim_id)
      deactivate API
      loop 理赔等待/补证
        API-->>Backend: Claim Update(补证/进度)
        Backend-->>CS: 待补资料提示
        deactivate Backend
        deactivate CS
        CS->>Backend: Upload Evidence
        activate Backend
        activate CS
        Backend->>API: SubmitEvidence
      end
      alt Approved(赔付金额)
        API-->>Backend: Claim Approved(amount)
        Backend->>Backend: 写入退款单 payment_refund(status=INIT, reason_code=LOST/DAMAGED,<br/> amount=赔付向用户部分/全额, initiator=SYSTEM, ticket_id)
        Backend->>Pay: RefundRequest(refund_no, amount)
        activate Pay
        Pay-->>Backend: SUCCESS
        deactivate Pay
        Backend->>Backend: 更新退款单状态 payment_refund.status=SUCCESS
        Backend-->>CS: 回填理赔结论 & 用户侧退款完成
        CS-->>Client: 通知用户结果
      else Denied
        API-->>Backend: Claim Denied(原因)
        Backend-->>CS: 人工决策（是否平台兜底/发券）
        deactivate Backend
        CS-->>Client: 告知结果
        deactivate CS
      end
    end
